<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Demucs Player — 完全修正版</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

<style>
body{background:#0f1115;color:#eaeaf0;margin:0}
main{max-width:960px;margin:16px auto;padding:12px}
.top{display:grid;grid-template-columns:90px 1fr 90px;gap:16px;align-items:center}
canvas{width:100%;height:300px;background:#0b0d12;border-radius:12px}
.btn{background:linear-gradient(90deg,#38bdf8,#4ade80);color:#012;border:none;padding:8px 12px;border-radius:8px;font-weight:700}
.v-slider{display:flex;flex-direction:column;align-items:center;height:180px}
.slider-vert{width:150px;transform:rotate(-90deg);margin-top:28px}
.log{background:#071018;color:#9fbfd6;font-size:.85rem;border-radius:8px;padding:8px;max-height:140px;overflow:auto}
</style>
</head>

<body>
<main>
<h2>Demucs Player</h2>

<div style="display:flex;gap:8px;margin-bottom:10px">
  <label class="btn" for="zipInput">ZIP</label>
  <label class="btn" for="filesInput">2ファイル</label>
  <button id="playBtn" class="btn" disabled>再生</button>
</div>

<div class="top">
  <div class="v-slider">
    <div>Vocals</div>
    <input id="volV" class="slider-vert" type="range" min="0" max="1" step="0.01" value="1">
  </div>

  <canvas id="viz"></canvas>

  <div class="v-slider">
    <div>Backing</div>
    <input id="volB" class="slider-vert" type="range" min="0" max="1" step="0.01" value="1">
  </div>
</div>

<input id="seek" type="range" min="0" max="1" step="0.01" value="0" style="width:100%;margin-top:12px">
<div style="display:flex;justify-content:space-between">
  <small id="cur">0:00</small>
  <small id="total">0:00</small>
</div>

<div style="display:flex;gap:8px;align-items:center">
  <div>Master</div>
  <input id="master" type="range" min="0" max="1" step="0.01" value="1" style="flex:1">
</div>

<pre id="log" class="log">ready</pre>
</main>

<input id="zipInput" type="file" accept=".zip" hidden>
<input id="filesInput" type="file" accept="audio/*" multiple hidden>

<script>
/* ========= Audio Core ========= */
let ctx, analyser, masterGain, gainV, gainB;
let buffers = {v:null,b:null};
let sources = {v:null,b:null};
let isPlaying = false;
let playPos = 0;
let raf;

/* ---------- utils ---------- */
const log = t => logEl.textContent += t + "\n";
const fmt = s => `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
const logEl = document.getElementById('log');

/* ---------- init ---------- */
function initCtx(){
  if(ctx) return;
  ctx = new AudioContext();
  analyser = ctx.createAnalyser();
  masterGain = ctx.createGain();
  gainV = ctx.createGain();
  gainB = ctx.createGain();

  gainV.connect(masterGain);
  gainB.connect(masterGain);
  masterGain.connect(analyser);
  analyser.connect(ctx.destination);
}

/* ---------- playback ---------- */
function stopSources(){
  ['v','b'].forEach(k=>{
    if(sources[k]){
      try{sources[k].stop()}catch{}
      sources[k]=null;
    }
  });
}

function startAt(t){
  initCtx();
  stopSources();
  playPos = t;

  sources.v = ctx.createBufferSource();
  sources.b = ctx.createBufferSource();
  sources.v.buffer = buffers.v;
  sources.b.buffer = buffers.b;

  sources.v.connect(gainV);
  sources.b.connect(gainB);

  const now = ctx.currentTime;
  sources.v.start(now, t);
  sources.b.start(now, t);

  sources.v.onended = ()=>stop();
  isPlaying = true;
}

function stop(){
  if(isPlaying){
    playPos += ctx.currentTime - startTime;
  }
  stopSources();
  isPlaying = false;
}

let startTime = 0;

/* ---------- controls ---------- */
document.getElementById('playBtn').onclick = async ()=>{
  initCtx();
  await ctx.resume();
  startTime = ctx.currentTime;
  startAt(playPos);
};

document.getElementById('seek').oninput = e=>{
  const v = Number(e.target.value);
  document.getElementById('cur').textContent = fmt(v);
  playPos = v;
  if(isPlaying){
    startTime = ctx.currentTime;
    startAt(v);
  }
};

document.getElementById('volV').oninput=e=>gainV.gain.value=e.target.value;
document.getElementById('volB').oninput=e=>gainB.gain.value=e.target.value;
document.getElementById('master').oninput=e=>masterGain.gain.value=e.target.value;

/* ---------- load ---------- */
async function loadBuffers(v,b){
  initCtx();
  buffers.v = await ctx.decodeAudioData(await v.arrayBuffer());
  buffers.b = await ctx.decodeAudioData(await b.arrayBuffer());
  const d = Math.min(buffers.v.duration,buffers.b.duration);
  seek.max = d;
  total.textContent = fmt(d);
  playBtn.disabled=false;
}

filesInput.onchange = ()=>{
  if(filesInput.files.length>=2){
    loadBuffers(filesInput.files[0],filesInput.files[1]);
  }
};

zipInput.onchange = async ()=>{
  const zip = await JSZip.loadAsync(zipInput.files[0]);
  const names = Object.keys(zip.files).filter(n=>/\.(wav|mp3)/i.test(n));
  const v = await zip.file(names[0]).async("blob");
  const b = await zip.file(names[1]).async("blob");
  loadBuffers(v,b);
};

/* ---------- background ---------- */
document.addEventListener("visibilitychange",()=>{
  if(document.hidden && isPlaying){
    playPos += ctx.currentTime - startTime;
    stopSources();
  }
});

/* ---------- viz ---------- */
const canvas=document.getElementById('viz');
const c=canvas.getContext('2d');
function draw(){
  raf=requestAnimationFrame(draw);
  if(!analyser) return;
  const data=new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);
  c.clearRect(0,0,canvas.width,canvas.height);
  data.forEach((v,i)=>{
    c.fillRect(i,canvas.height,1,-v);
  });
}
draw();
</script>
</body>
</html>
