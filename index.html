<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Demucs Player</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

<style>
body{
  background:#0f1115;color:#eaeaf0;margin:0;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto
}
main{max-width:900px;margin:18px auto;padding:14px}
.top{display:grid;grid-template-columns:90px 1fr 90px;gap:16px;align-items:center}
canvas{width:100%;height:260px;background:#0b0d12;border-radius:12px}
.btn{
  background:linear-gradient(90deg,#38bdf8,#4ade80);
  color:#012;border:none;padding:8px 12px;
  border-radius:8px;font-weight:700;cursor:pointer
}
.small{font-size:13px;color:#b8cbe0}
.log{
  background:#071018;color:#9fbfd6;
  font-size:.85rem;border-radius:8px;
  padding:8px;max-height:160px;overflow:auto;white-space:pre-wrap
}

/* 縦スライダー（長め） */
.slider-vert{
  width:150px;height:22px;
  transform:rotate(-90deg);
}

@media(max-width:760px){
  .top{grid-template-columns:1fr}
  .slider-vert{display:none}
}
</style>
</head>
<body>

<main>
<h2>Demucs Player</h2>

<div style="display:flex;gap:8px;margin-bottom:10px">
  <label class="btn" for="zipInput">ZIP読込</label>
  <label class="btn" for="filesInput">2ファイル</label>
  <button class="btn" id="playBtn" disabled>再生</button>
  <button class="btn" id="stopBtn" disabled>停止</button>
</div>

<div class="top">
  <div style="text-align:center">
    <div class="small">Vocals</div>
    <input id="volV" type="range" min="0" max="1" step="0.01" value="1" class="slider-vert">
  </div>

  <canvas id="viz"></canvas>

  <div style="text-align:center">
    <div class="small">Backing</div>
    <input id="volB" type="range" min="0" max="1" step="0.01" value="1" class="slider-vert">
  </div>
</div>

<div style="margin-top:14px">
  <input id="seek" type="range" min="0" max="1" step="0.01" value="0">
  <div style="display:flex;justify-content:space-between">
    <small id="cur">0:00</small>
    <small id="total">0:00</small>
  </div>

  <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
    <span class="small">Master</span>
    <input id="master" type="range" min="0" max="1" step="0.01" value="1" style="flex:1">
    <span id="filename" class="small">未選択</span>
  </div>

  <pre id="log" class="log">ready</pre>
</div>
</main>

<input id="zipInput" type="file" accept=".zip" hidden>
<input id="filesInput" type="file" accept="audio/*" multiple hidden>

<script>
/* ---------- util ---------- */
const logEl = document.getElementById('log');
const log = (...a)=>{ logEl.textContent+=a.join(' ')+'\\n'; logEl.scrollTop=1e9; };

const fmt = s=>{
  if(!isFinite(s))return'0:00';
  s=Math.floor(s);return`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
};

/* ---------- audio ---------- */
let ctx, analyser, masterGain, gainV, gainB;
let tracks={vocals:null,backing:null};
let buffers={}, sources={}, paused=0, playing=false;

function ensureCtx(){
  if(ctx) return;
  ctx=new (AudioContext||webkitAudioContext)();
  analyser=ctx.createAnalyser(); analyser.fftSize=512;
  masterGain=ctx.createGain();
  gainV=ctx.createGain(); gainB=ctx.createGain();
  gainV.connect(masterGain); gainB.connect(masterGain);
  masterGain.connect(analyser); analyser.connect(ctx.destination);
  log('AudioContext ready');
}

async function decode(ab){
  ensureCtx();
  try{
    return await new Promise((res,rej)=>ctx.decodeAudioData(ab,res,rej));
  }catch{return null;}
}

/* ---------- load ---------- */
async function setTracks(vBlob,bBlob,vName,bName){
  const vb=await decode(await vBlob.arrayBuffer());
  const bb=await decode(await bBlob.arrayBuffer());
  if(!vb||!bb){ alert('decode失敗'); return; }

  tracks.vocals={mode:'buffer',buf:vb};
  tracks.backing={mode:'buffer',buf:bb};
  buffers={vocals:vb,backing:bb};

  const d=Math.min(vb.duration,bb.duration);
  seek.max=d; total.textContent=fmt(d);
  filename.textContent=vName+' / '+bName;
  playBtn.disabled=stopBtn.disabled=false;
  log('tracks loaded');
}

zipInput.onchange=async()=>{
  const zip=await JSZip.loadAsync(zipInput.files[0]);
  const names=Object.keys(zip.files).filter(n=>/\.(wav|mp3|m4a)$/i.test(n));
  if(names.length<2)return alert('音声2つ必要');
  const v=names.find(n=>/vocals/i.test(n))||names[0];
  const b=names.find(n=>/inst|back|no_vocals/i.test(n))||names[1];
  await setTracks(await zip.file(v).async('blob'),await zip.file(b).async('blob'),v,b);
};

filesInput.onchange=async()=>{
  const f=[...filesInput.files];
  if(f.length<2)return alert('2つ選択');
  await setTracks(f[0],f[1],f[0].name,f[1].name);
};

/* ---------- play ---------- */
function stop(){
  Object.values(sources).forEach(s=>{try{s.stop()}catch{}});
  sources={};
  paused=getTime();
  playing=false; playBtn.textContent='再生';
}

function start(){
  ensureCtx();
  ctx.resume();
  stop();
  const t=Number(seek.value)||0;
  ['vocals','backing'].forEach(k=>{
    const s=ctx.createBufferSource();
    s.buffer=buffers[k];
    s.connect(k==='vocals'?gainV:gainB);
    s.start(0,t);
    sources[k]=s;
  });
  playing=true; playBtn.textContent='停止';
}

function getTime(){
  if(!sources.vocals)return paused;
  return paused+(ctx.currentTime-(sources.vocals.startTime||0));
}

/* ---------- UI ---------- */
playBtn.onclick=()=>playing?stop():start();
stopBtn.onclick=stop;
volV.oninput=()=>gainV&&(gainV.gain.value=volV.value);
volB.oninput=()=>gainB&&(gainB.gain.value=volB.value);
master.oninput=()=>masterGain&&(masterGain.gain.value=master.value);
seek.oninput=()=>cur.textContent=fmt(seek.value);

setInterval(()=>{
  if(playing){
    const t=getTime();
    seek.value=t; cur.textContent=fmt(t);
  }
},200);

/* ---------- viz ---------- */
const c=viz.getContext('2d'),freq=new Uint8Array(256);
(function draw(){
  c.clearRect(0,0,viz.width,viz.height);
  if(analyser){
    analyser.getByteFrequencyData(freq);
    const w=viz.width/freq.length, h=viz.height/2;
    for(let i=0;i<freq.length;i+=2){
      const v=freq[i]/255*h;
      c.fillStyle='#38bdf8';
      c.fillRect(i*w,h-v,w*0.8,v);
      c.fillRect(i*w,h,w*0.8,v);
    }
  }
  requestAnimationFrame(draw);
})();
</script>
</body>
</html>
